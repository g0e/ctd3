var ctd3=function(){"use strict";var a={version:"0.0.0"};return a.instances={},a.get_instance=function(b){return"string"==typeof b?a.instances[b]:null},a.options={},a.Table=function(b,c){this.div_id=b,a.instances[b]=this,this.dataset_manager={},this.tag_table={},this.dataset={},this.meta=[],this.loader=new a.DatasetLoader(this),this.init_dataset(c)},a.Table.prototype.init_dataset=function(b){this.dataset_manager instanceof a.DatasetManager||(this.dataset_manager=new a.DatasetManager(this,this.dataset_manager),this.dm=this.dataset_manager),this.dataset=this.dataset_manager.setup_dataset(b),this.meta=this.dataset_manager.create_default_meta(),this.dm.view_col_cursor=this.dm.view_fix_col_size},a.Table.prototype.setup_meta=function(a){this.dataset_manager.setup_meta(a),this.dataset_manager.sort_meta()},a.Table.prototype.setup_dm_options=function(b){a.Util.merge(this.dataset_manager,b),this.dm.view_col_cursor=this.dm.view_fix_col_size},a.Table.prototype.render=function(b){this.tag_table instanceof a.Parts.TagTable||(this.tag_table=new a.Parts.TagTable(this,this.tag_table)),void 0===b&&(b={}),b.table_render_only||(b.skip_filter_dataset||this.dataset_manager.filter_dataset(),this.dataset_manager.sort_dataset(),this.dataset_manager.reset_view()),this.tag_table.render()},a.Parts=function(a,b){this.init(a,b)},a.Parts.prototype.get_defaults=function(){return{}},a.Parts.prototype.init=function(a,b){var c,d=this.get_defaults();this.table=a;for(c in b)b.hasOwnProperty(c)&&(this[c]=b[c]);for(c in d)this.hasOwnProperty(c)||(this[c]=d[c])},a.Parts.prototype.render=function(){},a.Parts.TagTable=function(){a.Parts.apply(this,arguments)},a.Parts.TagTable.prototype=new a.Parts,a.Parts.TagTable.prototype.get_defaults=function(){return{}},a.Parts.TagTable.prototype.render=function(){var a=this.table.dataset_manager.ds_view,b=this.table.dataset_manager.meta_view,c=this.table.dataset_manager,d=this;if(this.div||(this.div=d3.select("#"+this.table.div_id).attr("class","ctd3").append("div").attr("class","ctd3_tag_table"),this.tag_table=this.div.append("table"),this.tag_thead=this.tag_table.append("thead"),this.tag_thead_tr_label=this.tag_thead.append("tr"),this.tag_thead_tr_filter=this.tag_thead.append("tr"),this.tag_tbody=this.tag_table.append("tbody").attr("class","ctd3_tbody_data"),this.tag_tfoot=this.tag_table.append("tfoot"),this.tag_tfoot_div=this.tag_tfoot.append("tr").append("th").attr("colspan",b.length+2).append("div").attr("class","ctd3_tfoot_div")),c.can_scroll_up()){var e=this.tag_table.selectAll(".ctd3_tbody_scroll_up").data([0]);e.enter().insert("tbody",".ctd3_tbody_data").attr("class","ctd3_tbody_scroll_up").append("tr").append("td").attr("colspan",100),e.select("td").call(this.update_scroll_up_td,this.table)}else this.tag_table.select(".ctd3_tbody_scroll_up").remove();if(c.can_scroll_down()){var f=this.tag_table.selectAll(".ctd3_tbody_scroll_down").data([0]);f.enter().insert("tbody","tfoot").attr("class","ctd3_tbody_scroll_down").append("tr").append("td").attr("colspan",100),f.select("td").call(this.update_scroll_down_td,this.table)}else this.tag_table.select(".ctd3_tbody_scroll_down").remove();a.length>0&&(c.can_scroll_left()&&b.unshift({name:"__scroll_left",__pos:c.view_fix_col_size-.5}),c.can_scroll_right()&&b.push({name:"__scroll_right",__pos:b.length}));var g=this.tag_thead_tr_label.selectAll("th.ctd3_th_label").data(b,function(a){return a.name});g.enter().append("th").each(function(a){d3.select(this).attr("class",function(a){return"ctd3_th_label ctd3_th_"+a.name}).attr("style","cursor:pointer;").on("click",function(a){var b=d.table.dataset_manager,c=b.meta;a.sort="asc"==a.sort?void 0:"desc"==a.sort?"asc":"desc";for(var e=0;e<c.length;e++)c[e].name!==a.name&&(c[e].sort=null);b.view_row_cursor=0,d.table.render({skip_filter_dataset:!0})}).append("div").attr("class",function(){return"__"==a.name.substring(0,2)?null:"ctd3_cell_div"}).style("width",function(a){return a.width?a.width:null})}),g.each(function(a){d3.select(this).select("div").html(function(){if("__"==a.name.substring(0,2))return"";var b=void 0!==a.label?a.label:a.name;return"asc"==a.sort?b+="<span style='font-size:x-small;'>&#9650;</span>":"desc"==a.sort&&(b+="<span style='font-size:x-small;'>&#9660;</span>"),b})}),g.sort(function(a,b){return a.__pos-b.__pos}),g.exit().remove(),c.show_filter_form&&(g=this.tag_thead_tr_filter.selectAll("th.ctd3_th_filter").data(b,function(a){return a.name}),g.enter().append("th").each(function(a){var b=d3.select(this),c=b.attr("class",function(a){return"ctd3_th_filter ctd3_th_"+a.name}).append("div").attr("class",function(){return"__"==a.name.substring(0,2)?null:"ctd3_cell_div"}).style("width",function(a){return a.width?a.width:null});d.create_filter_form(c,a)}),g.sort(function(a,b){return a.__pos-b.__pos}),g.exit().remove());var h,i=this.tag_tbody.select("tr.ctd3_tr_scroll");c.can_scroll_right()||c.can_scroll_left()?(i[0][0]||(i=this.tag_tbody.append("tr").attr("class","ctd3_tr_scroll")),h=i.selectAll("td.ctd3_td_scroll").data(b,function(a){return a.name}),h.enter().append("td").attr("class","ctd3_td_scroll"),h.each(function(a){k=d3.select(this),"__scroll_right"==a.name?k.attr("rowspan",100).call(d.update_scroll_right_td,d.table).attr("class","ctd3_td_scroll ctd3_td_scroll_right"):"__scroll_left"==a.name?k.attr("rowspan",100).call(d.update_scroll_left_td,d.table).attr("class","ctd3_td_scroll ctd3_td_scroll_left"):k.attr("class","ctd3_td_scroll ctd3_td_empty")}),h.sort(function(a,b){return a.__pos-b.__pos}),h.exit().remove()):i[0][0]&&i.remove(),a.length>0&&(c.can_scroll_right()&&b.pop(),c.can_scroll_left()&&b.shift());var j=this.tag_tbody.selectAll("tr.ctd3_tr_data").data(a,function(a){return a.__id});j.enter().append("tr").attr("class",function(a){return"ctd3_tr_data ctd3_tr_id_"+a.__id}),j.sort(function(a,b){return a.__pos-b.__pos}),j.exit().remove();var k;j.each(function(a){k=d3.select(this).selectAll("td.ctd3_td_data").data(b,function(a){return a.name}),k.enter().append("td").html(function(c,d){var e=a[c.name];return void 0!==b[d].text_format&&(e=b[d].text_format(e,b[d])),e=void 0!==b[d].html_format?b[d].html_format(e,b[d],a[c.name]):"<div>"+e+"</div>"}).attr("class",function(a,c){var d=b[c].css_class?b[c].css_class.join(" "):"";return"ctd3_td_data ctd3_td_"+a.name+" "+d}).attr("style",function(c,d){return void 0!==b[d].td_style?b[d].td_style(b[d],a[c.name]):null}).select("div").attr("class","ctd3_cell_div").style("width",function(a,c){return b[c].width?b[c].width:null}),k.sort(function(a,b){return a.__pos-b.__pos}),k.exit().remove()}),0===a.length?null===this.tag_tbody.select("tr.ctd3_tr_empty_dataset")[0][0]&&this.tag_tbody.append("tr").attr("class","ctd3_tr_empty_dataset").append("td").attr("colspan",b.length).append("div").attr("class","ctd3_div_empty_dataset").text("no data found"):this.tag_tbody.select("tr.ctd3_tr_empty_dataset").remove(),this.tag_tfoot_div.select("*").remove(),this.tag_tfoot_div.call(function(b){b.append("span").text(function(){var b="";return b+="shown="+(c.view_row_cursor+1)+"-"+(c.view_row_cursor+a.length),b+=" / ",b+="filtered="+c.ds_sorted.length,b+=" / ",b+="overall="+c.dataset.length})})},a.Parts.TagTable.prototype.create_filter_form=function(a,b){var c=this,d=this.table.dataset_manager;if("__"!=b.name.substring(0,2))if("text"==b.filter_type)a.html(function(){var a=void 0!==b.filter_value?"value='"+b.filter_value+"'":"",c="<input type='text' name='"+b.name+"' "+a+" />";return c}).select("input").on("keyup",function(a){var b=d3.select(this).property("value"),d=c.table.dataset_manager;a.filter_value=""!==b?b:void 0,d.view_row_cursor=0,c.table.render()});else if("select"==b.filter_type){var e=a.append("select");e.call(function(){var a,c,f=[];for(a=0,c=d.dataset.length;c>a;a++)-1==f.indexOf(d.dataset[a][b.name])&&f.push(d.dataset[a][b.name]);for(e.append("option").attr("value","").text("-"),a=0,c=f.length;c>a;a++)e.append("option").attr("value",f[a]).text(f[a]).attr("selected",function(){return b.filter_value==f[a]?"":null})}).on("change",function(a){var b=d3.select(this).property("value"),d=c.table.dataset_manager;a.filter_value=""!==b?b:void 0,d.view_row_cursor=0,c.table.render()})}},a.Parts.TagTable.prototype.update_scroll_up_td=function(a,b){var c=b.dataset_manager;a.select(".ctd3_scroll_up_div")[0][0]||a.style("cursor","pointer").on("click",function(){b.dataset_manager.scroll_row_view.call(b.dataset_manager,-1*c.view_row_size),b.render({table_render_only:!0})}).append("div").attr("class","ctd3_scroll_up_div").append("span").html("&#9650; previous page")},a.Parts.TagTable.prototype.update_scroll_down_td=function(a,b){var c=b.dataset_manager;a.select(".ctd3_scroll_down_div")[0][0]||a.style("cursor","pointer").on("click",function(){b.dataset_manager.scroll_row_view.call(b.dataset_manager,c.view_row_size),b.render({table_render_only:!0})}).append("div").attr("class","ctd3_scroll_down_div").append("span").html("&#9660;next page ")},a.Parts.TagTable.prototype.update_scroll_left_td=function(a,b){var c=b.dataset_manager;a.select(".ctd3_scroll_left_div")[0][0]||a.style("cursor","pointer").on("click",function(){b.dataset_manager.scroll_col_view.call(b.dataset_manager,-1*(c.view_col_size-c.view_fix_col_size)),b.render({table_render_only:!0})}).append("div").attr("class","ctd3_scroll_left_div").append("span").html("&#9664;")},a.Parts.TagTable.prototype.update_scroll_right_td=function(a,b){var c=b.dataset_manager;a.select(".ctd3_scroll_right_div")[0][0]||a.style("cursor","pointer").on("click",function(){b.dataset_manager.scroll_col_view.call(b.dataset_manager,c.view_col_size-c.view_fix_col_size),b.render({table_render_only:!0})}).append("div").attr("class","ctd3_scroll_right_div").append("span").html("&#9654;")},a.DatasetManager=function(b,c){this.table=b,a.Util.merge(this,this.get_defaults()),a.Util.merge(this,c)},a.DatasetManager.prototype.get_defaults=function(){return{meta:void 0,dataset:void 0,ds_filtered:void 0,ds_sorted:void 0,ds_view:void 0,meta_view:void 0,view_row_cursor:0,view_col_cursor:0,view_row_size:10,view_col_size:12,view_fix_col_size:2,show_filter_form:!0}},a.DatasetManager.prototype.setup_dataset=function(b){b&&(this.dataset=a.Util.copy(b));for(var c=0,d=this.dataset.length;d>c;c++)this.dataset[c].__id=c;return this.dataset},a.DatasetManager.prototype.create_default_meta=function(){var a,b,c=[],d=this.dataset[0];for(var e in d)d.hasOwnProperty(e)&&"__"!==e.substring(0,2)&&(b=[],"number"==typeof d[e]?(a=d3.format(","),b.push("text_align_right")):a=void 0,c.push({name:e,text_format:a,css_class:b,filter_type:"text"}));return this.meta=c,this.meta},a.DatasetManager.prototype.setup_meta=function(b){for(var c=0,d=this.meta.length;d>c;c++)b.hasOwnProperty(this.meta[c].name)&&a.Util.merge(this.meta[c],b[this.meta[c].name])},a.DatasetManager.prototype.sort_meta=function(){this.meta.sort(function(a,b){var c=void 0===a.order?999999:a.order,d=void 0===b.order?999999:b.order;return c>d?1:d>c?-1:0})},a.DatasetManager.prototype.enable_incell_visualize=function(a,b){for(var c,d=0,e=this.meta.length;e>d;d++)this.meta[d].name==a&&(c=d);if(void 0!==c){void 0===b&&(b="bar");var f=this,g=d3.extent(this.dataset,function(a){return a[f.meta[c].name]});"bar"==b?(this.meta[c].scale=d3.scale.linear().range([0,100]).domain(g),this.meta[c].html_format=function(a,b,c){return"<div style='position:relative;'><div style='background-color:lightblue;position:absolute;z-index:1;height:100%;width:"+b.scale(c)+"%;'> </div><div style='position:relative;z-index:2;'>"+a+"</div></div>"}):"gradation"==b&&(this.meta[c].scale=d3.scale.linear().range(["green","red"]).domain(g).interpolate(d3.interpolateHsl),this.meta[c].html_format=function(a){return"<div>"+a+"</div>"},this.meta[c].td_style=function(a,b){return"background-color:"+a.scale(b)+";"})}},a.DatasetManager.prototype.filter_dataset=function(){var a,b,c,d=[];for(a=0;a<this.meta.length;a++)void 0!==this.meta[a].filter_value&&(c=this.meta[a],"text"==c.filter_type&&void 0!==c.filter_value?d.push(function(a){for(var b=this.filter_value.split(" "),c=0;c<b.length;c++)if(0===b[c].indexOf("<=")||0===b[c].indexOf("=<")){if(1*a[this.name]>1*b[c].replace("<","").replace("=",""))return!1}else if(0===b[c].indexOf(">=")||0===b[c].indexOf("=>")){if(1*a[this.name]<1*b[c].replace(">","").replace("=",""))return!1}else if(0===b[c].indexOf("<")){if(1*a[this.name]>=1*b[c].replace("<",""))return!1}else if(0===b[c].indexOf(">")){if(1*a[this.name]<=1*b[c].replace(">",""))return!1}else if(0===b[c].indexOf("=")){if(""+a[this.name]!==b[c].replace("=",""))return!1}else if(-1==(""+a[this.name]).indexOf(""+b[c]))return!1;return!0}.bind(c)):"select"==c.filter_type&&void 0!==c.filter_value&&d.push(function(a){return""+a[this.name]==""+this.filter_value}.bind(c)));this.ds_filtered=[];a:for(a=0;a<this.dataset.length;a++){for(b=0;b<d.length;b++)if(!d[b](this.dataset[a]))continue a;this.ds_filtered.push(this.dataset[a])}return this.ds_filtered},a.DatasetManager.prototype.sort_dataset=function(){var a,b=[];for(this.ds_sorted=[],a=0;a<this.ds_filtered.length;a++)this.ds_sorted.push(this.ds_filtered[a]);for(a=0;a<this.meta.length;a++)"asc"==this.meta[a].sort?b.push(function(a,b){var c=a[this.name],d=b[this.name];return c>d?1:d>c?-1:0}.bind(this.meta[a])):"desc"==this.meta[a].sort&&b.push(function(a,b){var c=a[this.name],d=b[this.name];return c>d?-1:d>c?1:0}.bind(this.meta[a]));for(a=0;a<b.length;a++)this.ds_sorted.sort(b[a]);return this.ds_sorted},a.DatasetManager.prototype.reset_view=function(){var a;for(this.ds_view=[],a=0;a<this.view_row_size&&a+this.view_row_cursor<this.ds_sorted.length;a++)this.ds_view.push(this.ds_sorted[a+this.view_row_cursor]);for(this.refresh_ds_view_pos(),this.meta_view=[],a=0;a<this.view_fix_col_size;a++)this.meta_view.push(this.meta[a]);for(a=0;a<this.view_col_size-this.view_fix_col_size;a++)a+this.view_col_cursor<this.meta.length&&this.meta_view.push(this.meta[a+this.view_col_cursor]);this.refresh_meta_view_pos()},a.DatasetManager.prototype.can_scroll_up=function(){return this.view_row_cursor>0?!0:!1},a.DatasetManager.prototype.can_scroll_down=function(){return this.view_row_cursor+this.ds_view.length<this.ds_sorted.length?!0:!1},a.DatasetManager.prototype.scroll_row_view=function(a){var b,c=this.ds_view.length,d=this.ds_sorted.length;if(a>0)for(b=0;a>b&&this.view_row_cursor+c<d;b++)this.ds_view.shift(),this.view_row_cursor++,this.ds_view.push(this.ds_sorted[this.view_row_cursor+c-1]);else if(0>a)for(a=Math.abs(a),b=0;a>b&&this.view_row_cursor>0;b++)this.ds_view.pop(),this.view_row_cursor--,this.ds_view.unshift(this.ds_sorted[this.view_row_cursor]);this.refresh_ds_view_pos()},a.DatasetManager.prototype.can_scroll_left=function(){return this.view_col_cursor-this.view_fix_col_size>0?!0:!1},a.DatasetManager.prototype.can_scroll_right=function(){return this.view_col_cursor+(this.view_col_size-this.view_fix_col_size)<this.meta.length?!0:!1},a.DatasetManager.prototype.scroll_col_view=function(a){var b,c=this.meta.length,d=[];for(b=0;b<this.view_fix_col_size;b++)d.push(this.meta_view.shift());var e=this.meta_view.length;if(a>0)for(b=0;a>b&&this.view_col_cursor+e<c;b++)this.meta_view.shift(),this.view_col_cursor++,this.meta_view.push(this.meta[this.view_col_cursor+e-1]);else if(0>a)for(a=Math.abs(a),b=0;a>b&&this.view_col_cursor-this.view_fix_col_size>0;b++)this.meta_view.pop(),this.view_col_cursor--,this.meta_view.unshift(this.meta[this.view_col_cursor]);for(b=0;b<this.view_fix_col_size;b++)this.meta_view.unshift(d.pop());this.refresh_meta_view_pos()},a.DatasetManager.prototype.refresh_ds_view_pos=function(){for(var a=0,b=this.ds_view.length;b>a;a++)this.ds_view[a].__pos=a},a.DatasetManager.prototype.refresh_meta_view_pos=function(){for(var a=0,b=this.meta_view.length;b>a;a++)this.meta_view[a].__pos=a},a.DatasetLoader=function(a){this.table=a,this.base_url=void 0,this.url_params={},this.dataset_filter=void 0},a.DatasetLoader.prototype.xhr_load=function(a){var b=this.setup_url(a,this.base_url);d3.json(b,function(a){this.dataset_filter&&(a=this.dataset_filter.apply(this,[a])),this.table.setup_dataset(a),this.table.render()}.bind(this))},a.DatasetLoader.prototype.setup_url=function(b,c){c||(c=this.base_url),b=a.Util.merge(this.url_params,b);var d,e,f="",g=c.split("?"),h={};if(g[1]){d=g[1].split("&");for(var i=0;i<d.length;i++)e=d[i].split("="),h[e[0]]=e[1]}a.Util.merge(h,b);for(var j in h)h.hasOwnProperty(j)&&null!==h[j]&&(""!==f&&(f+="&"),f+=j+"="+h[j]);return g[0]+"?"+f},a.Util={},a.Util.merge=function(b,c){for(var d in c)c.hasOwnProperty(d)&&(b[d]=d in b&&"object"==typeof b[d]&&"object"==typeof c[d]?a.Util.merge(b[d],c[d]):c[d]);return b},a.Util.copy=function(b){if(null===b||void 0===b||"object"!=typeof b)return b;var c;if(b instanceof Date)return c=new Date,c.setTime(b.getTime()),c;if(b instanceof Array){c=[];for(var d=0,e=b.length;e>d;d++)c[d]=a.Util.copy(b[d]);return c}if(b instanceof Object){c={};for(var f in b)b.hasOwnProperty(f)&&(c[f]=a.Util.copy(b[f]));return c}throw new Error("Unable to copy obj! Its type isn't supported.")},a}();