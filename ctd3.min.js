var ctd3=function(){"use strict";var a={version:"0.1.0"};return a.instances={},a.get_instance=function(b){return"string"==typeof b?a.instances[b]:null},a.options={},a.Table=function(b,c){this.div_id=b,this.div=d3.select("#"+this.div_id).style("position","relative"),a.instances[b]=this,this.initialized=!1,this.dataset_manager={},this.tag_table={},this.dataset={},this.meta=[],this.caption=void 0,this.row_cursor=0,this.col_cursor=0,this.table_row_size=10,this.table_col_size=10,this.table_fix_col_size=0,this.show_filter_form=!0,this.show_footer_info=!0,this.auto_resize=!1,this.width=void 0,this.col_fix_size=13,this.loader=new a.DatasetLoader(this),c&&this.init_dataset(c)},a.Table.prototype.init_dataset=function(b){this.dataset_manager instanceof a.DatasetManager||(this.dataset_manager=new a.DatasetManager(this,this.dataset_manager),this.dm=this.dataset_manager),this.dataset=this.dataset_manager.setup_dataset(b),this.meta=this.dataset_manager.create_default_meta(),this.col_cursor=this.table_fix_col_size,this.initialized=!0},a.Table.prototype.setup_meta=function(a){this.dataset_manager.setup_meta(a),this.dataset_manager.sort_meta()},a.Table.prototype.setup_options=function(b){a.Util.merge(this,b),this.col_cursor=this.table_fix_col_size},a.Table.prototype.render=function(b){if(this.tag_table instanceof a.Parts.TagTable||(this.tag_table=new a.Parts.TagTable(this,this.tag_table)),void 0===b&&(b={}),b.table_render_only||(b.skip_filter_dataset||this.dataset_manager.filter_dataset(),this.dataset_manager.sort_dataset(),this.dataset_manager.reset_view()),this.auto_resize){this.resize_calc();var c=this;d3.select(window).on("resize."+this.div_id,function(){c.resize_calc(),c.render({table_render_only:!0})})}this.tag_table.render()},a.Table.prototype.resize_calc=function(){this.width=d3.select("#"+this.div_id)[0][0].clientWidth||this.width;var a,b,c,d=0,e=0;for(a=0;a<this.meta.length;a++)c=this.meta[a],b=c.width2,b?"px"==(""+b).slice(-2)?e+=1*b.replace("px",""):d+="%"==(""+b).slice(-1)?1*b.replace("%","")/100:b:d+=1;e+=this.col_fix_size*this.meta.length;var f=e,g=this.width-f;for(a=0;a<this.meta.length;a++)c=this.meta[a],b=c.width2,c.width=b?"px"==(""+b).slice(-2)?1*b.replace("px",""):"%"==(""+b).slice(-1)?1*b.replace("%","")/100/d*g:1*b/d*g:1/d*g},a.Parts=function(a,b){this.init(a,b)},a.Parts.prototype.get_defaults=function(){return{}},a.Parts.prototype.init=function(a,b){var c,d=this.get_defaults();this.table=a;for(c in b)b.hasOwnProperty(c)&&(this[c]=b[c]);for(c in d)this.hasOwnProperty(c)||(this[c]=d[c])},a.Parts.prototype.render=function(){},a.Parts.TagTable=function(){a.Parts.apply(this,arguments)},a.Parts.TagTable.prototype=new a.Parts,a.Parts.TagTable.prototype.get_defaults=function(){return{}},a.Parts.TagTable.prototype.render=function(){var a=this,b=this.table,c=this.table.dataset_manager.ds_view,d=this.table.dataset_manager.meta_view,e=this.table.dataset_manager;if(this.div||(this.div=this.table.div.attr("class","ctd3").append("div").attr("class","ctd3_tag_table"),this.tag_table=this.div.append("table"),b.caption&&this.tag_table.append("caption").text(b.caption),this.tag_thead=this.tag_table.append("thead"),this.tag_thead_tr_label=this.tag_thead.append("tr"),this.tag_thead_tr_filter=this.tag_thead.append("tr"),this.tag_tbody=this.tag_table.append("tbody").attr("class","ctd3_tbody_data"),this.tag_tfoot=this.tag_table.append("tfoot"),this.tag_tfoot_div=this.tag_tfoot.append("tr").append("th").attr("colspan",d.length+2).append("div").attr("class","ctd3_tfoot_div")),e.can_scroll_up()){var f=this.tag_table.selectAll(".ctd3_tbody_scroll_up").data([0]);f.enter().insert("tbody",".ctd3_tbody_data").attr("class","ctd3_tbody_scroll_up").append("tr").append("td").attr("colspan",b.table_col_size+2).style("cursor","pointer").on("click",function(){b.row_cursor-=b.table_row_size,e.reset_view(),b.render({table_render_only:!0})}).append("div").attr("class","ctd3_scroll_up_div").append("span").html(function(){return"&#9650; 前の"+e.can_scroll_up(b.table_row_size)+"件を表示"})}else this.tag_table.select(".ctd3_tbody_scroll_up").remove();if(e.can_scroll_down()){var g=this.tag_table.selectAll(".ctd3_tbody_scroll_down").data([0]);g.enter().insert("tbody","tfoot").attr("class","ctd3_tbody_scroll_down").append("tr").append("td").attr("colspan",b.table_col_size+2).style("cursor","pointer").on("click",function(){b.row_cursor+=b.table_row_size,e.reset_view(),b.render({table_render_only:!0})}).append("div").attr("class","ctd3_scroll_down_div").append("span").html(function(){return"&#9660; 次の"+e.can_scroll_down(b.table_row_size)+"件を表示"})}else this.tag_table.select(".ctd3_tbody_scroll_down").remove();c.length>0&&(e.can_scroll_left()&&d.unshift({name:"__scroll_left",__pos:b.table_fix_col_size-.5}),e.can_scroll_right()&&d.push({name:"__scroll_right",__pos:d.length}));var h=this.tag_thead_tr_label.selectAll("th.ctd3_th_label").data(d,function(a){return a.name});h.enter().append("th").each(function(c){d3.select(this).attr("class",function(a){return"ctd3_th_label ctd3_th_"+a.name}).attr("style","cursor:pointer;").on("click",function(c){var d=a.table.dataset_manager,e=d.meta;c.sort="asc"==c.sort?void 0:"desc"==c.sort?"asc":"desc";for(var f=0;f<e.length;f++)e[f].name!==c.name&&(e[f].sort=null);b.row_cursor=0,a.table.render({skip_filter_dataset:!0})}).append("div").attr("class",function(){return"__"==c.name.substring(0,2)?null:"ctd3_cell_div"})}),h.each(function(a){d3.select(this).select("div").style("width",function(a){return a.width?a.width+"px":null}).html(function(){if("__"==a.name.substring(0,2))return"";var b=void 0!==a.label?a.label:a.name;return"asc"==a.sort?b+="<span style='font-size:x-small;'>&#9650;</span>":"desc"==a.sort&&(b+="<span style='font-size:x-small;'>&#9660;</span>"),b})}),h.sort(function(a,b){return a.__pos-b.__pos}),h.exit().remove(),this.table.show_filter_form&&(h=this.tag_thead_tr_filter.selectAll("th.ctd3_th_filter").data(d,function(a){return a.name}),h.enter().append("th").each(function(b){var c=d3.select(this),d=c.attr("class",function(a){return"ctd3_th_filter ctd3_th_"+a.name}).append("div").attr("class",function(){return"__"==b.name.substring(0,2)?null:"ctd3_cell_div"}).style("width",function(a){return a.width?a.width+"px":null});a.create_filter_form(d,b)}),h.each(function(){d3.select(this).select("div").style("width",function(a){return a.width?a.width+"px":null})}),h.sort(function(a,b){return a.__pos-b.__pos}),h.exit().remove());var i,j=this.tag_tbody.select("tr.ctd3_tr_scroll");e.can_scroll_right()||e.can_scroll_left()?(j[0][0]||(j=this.tag_tbody.append("tr").attr("class","ctd3_tr_scroll")),i=j.selectAll("td.ctd3_td_scroll").data(d,function(a){return a.name}),i.enter().append("td").attr("class","ctd3_td_scroll").each(function(a){l=d3.select(this),"__scroll_right"==a.name?l.attr("rowspan",100).attr("class","ctd3_td_scroll ctd3_td_scroll_right").style("cursor","pointer").on("click",function(){b.col_cursor+=b.table_col_size-b.table_fix_col_size,e.reset_view(),b.render({table_render_only:!0})}).append("div").attr("class","ctd3_scroll_right_div").append("span").html("&#9654;"):"__scroll_left"==a.name?l.attr("rowspan",100).attr("class","ctd3_td_scroll ctd3_td_scroll_left").style("cursor","pointer").on("click",function(){b.col_cursor-=b.table_col_size-b.table_fix_col_size,e.reset_view(),b.render({table_render_only:!0})}).append("div").attr("class","ctd3_scroll_left_div").append("span").html("&#9664;"):l.attr("class","ctd3_td_scroll ctd3_td_empty")}),i.sort(function(a,b){return a.__pos-b.__pos}),i.exit().remove()):j[0][0]&&j.remove(),c.length>0&&(e.can_scroll_right()&&d.pop(),e.can_scroll_left()&&d.shift());var k=this.tag_tbody.selectAll("tr.ctd3_tr_data").data(c,function(a){return a.__id});k.enter().append("tr").attr("class",function(a){return"ctd3_tr_data ctd3_tr_id_"+a.__id}),k.sort(function(a,b){return a.__pos-b.__pos}),k.exit().remove();var l;k.each(function(a,b){l=d3.select(this).selectAll("td.ctd3_td_data").data(d,function(a){return a.name}),l.enter().append("td").html(function(b,c){var e=a[b.name];return void 0!==d[c].text_format&&(e=d[c].text_format(e,d[c],a)),d[c].show_tooltip&&(e="<span class='ctd3_tooltip_span'>"+e+"</span>"+e),e=void 0!==d[c].html_format?d[c].html_format(e,d[c],a[b.name],a):"<div>"+e+"</div>"}).each(function(a,c){if(void 0!==d[c].js_format){var e=d3.select(this.parentNode.parentNode).datum();d[c].js_format.bind(this)(a,e,b,c)}}).attr("class",function(a,b){var c=d[b].css_class?d[b].css_class.join(" "):"";return"ctd3_td_data ctd3_td_"+a.name+" "+c}).attr("style",function(b,c){return void 0!==d[c].td_style?d[c].td_style(d[c],a[b.name]):null}).select("div").attr("class","ctd3_cell_div"),l.style("width",function(a,b){return d[b].width?d[b].width+"px":null}),l.sort(function(a,b){return a.__pos-b.__pos}),l.exit().remove()}),0===c.length?null===this.tag_tbody.select("tr.ctd3_tr_empty_dataset")[0][0]&&this.tag_tbody.append("tr").attr("class","ctd3_tr_empty_dataset").append("td").attr("colspan",d.length).append("div").attr("class","ctd3_div_empty_dataset").text("no data found"):this.tag_tbody.select("tr.ctd3_tr_empty_dataset").remove(),this.tag_tfoot_div.select("*").remove(),b.show_footer_info&&c.length!=e.dataset.length?this.tag_tfoot_div.attr("style",null).call(function(a){a.append("span").text(function(){var a="";return a+=c.length>0?""+(b.row_cursor+1)+"-"+(b.row_cursor+c.length):"0",a+=e.ds_sorted.length!=e.dataset.length?" / "+e.ds_sorted.length:" / "+e.dataset.length})}):this.tag_tfoot_div.attr("style","height:0.5em")},a.Parts.TagTable.prototype.create_filter_form=function(a,b){var c=this,d=this.table,e=this.table.dataset_manager;if("__"!=b.name.substring(0,2))if("text"==b.filter_type||"number"==b.filter_type)a.html(function(){var a=void 0!==b.filter_value?"value='"+b.filter_value+"'":"",c="<input type='text' name='"+b.name+"' "+a+" />";return c}).select("input").on("keyup",function(a){{var b=d3.select(this).property("value");c.table.dataset_manager}a.filter_value=""!==b?b:void 0,d.row_cursor=0,d.render()});else if("select"==b.filter_type){var f=a.append("select");f.call(function(){var a,c,d=[];for(a=0,c=e.dataset.length;c>a;a++)-1==d.indexOf(e.dataset[a][b.name])&&d.push(e.dataset[a][b.name]);for(f.append("option").attr("value","").text("-"),a=0,c=d.length;c>a;a++)f.append("option").attr("value",d[a]).text(d[a]).attr("selected",function(){return b.filter_value==d[a]?"":null})}).on("change",function(a){{var b=d3.select(this).property("value");c.table.dataset_manager}a.filter_value=""!==b?b:void 0,d.row_cursor=0,d.render()})}},a.Parts.OverlayLoading=function(){a.Parts.apply(this,arguments)},a.Parts.OverlayLoading.prototype=new a.Parts,a.Parts.OverlayLoading.prototype.get_defaults=function(){return{}},a.Parts.OverlayLoading.prototype.render=function(a){if(a){if(this.div=this.table.div.append("div").attr("class","ctd3_overlay_loading"),this.div.append("div"),this.div.append("span").text("Now Loading ... "),this.table.tag_table.tag_table){var b=this.table.tag_table.tag_table[0][0].offsetHeight,c=this.table.tag_table.tag_table[0][0].offsetWidth;this.div.select("div").style("width",c+"px").style("height","100%"),this.div.select("span").style("position","absolute").style("left",function(){return(c-this.offsetWidth)/2+"px"}).style("top",function(){return(b-this.offsetHeight)/2+"px"})}}else this.table.div.selectAll(".ctd3_overlay_loading").remove()},a.DatasetManager=function(b,c){this.table=b,a.Util.merge(this,this.get_defaults()),a.Util.merge(this,c)},a.DatasetManager.prototype.get_defaults=function(){return{meta:void 0,dataset:void 0,ds_filtered:void 0,ds_sorted:void 0,ds_view:void 0,meta_view:void 0,id_seq:0}},a.DatasetManager.prototype.setup_dataset=function(b){b&&(this.dataset=a.Util.copy(b));for(var c=0,d=this.dataset.length;d>c;c++)this.dataset[c].__id=c+this.id_seq;return this.id_seq+=this.dataset.length,this.dataset},a.DatasetManager.prototype.create_default_meta=function(){var a,b,c=[],d=this.dataset[0];for(var e in d)d.hasOwnProperty(e)&&"__"!==e.substring(0,2)&&(b=[],"number"==typeof d[e]?(a=d3.format(","),b.push("text_align_right")):a=void 0,c.push({name:e,text_format:a,css_class:b,filter_type:"text"}));return this.meta=c,this.meta},a.DatasetManager.prototype.setup_meta=function(b){for(var c=0,d=this.meta.length;d>c;c++)b.hasOwnProperty(this.meta[c].name)&&(a.Util.merge(this.meta[c],b[this.meta[c].name]),b[this.meta[c].name].visualize&&this.enable_incell_visualize(c,b[this.meta[c].name].visualize))},a.DatasetManager.prototype.sort_meta=function(){this.meta.sort(function(a,b){var c=void 0===a.order?999999:a.order,d=void 0===b.order?999999:b.order;return c>d?1:d>c?-1:0})},a.DatasetManager.prototype.enable_incell_visualize=function(a,b){var c=this,d=d3.extent(this.dataset,function(b){return b[c.meta[a].name]});if("bar"==b)this.meta[a].scale=d3.scale.linear().range([0,100]).domain(d),this.meta[a].html_format=function(a,b,c){var d=b.visualize_bar_color?b.visualize_bar_color:"lightblue";return"<div style='position:relative;'><div style='background-color:"+d+";position:absolute;z-index:1;height:100%;width:"+b.scale(c)+"%;'> </div><div style='position:relative;z-index:2;'>"+a+"</div></div>"};else if("gradation"==b){var e=this.meta[a].visualize_low_color?this.meta[a].visualize_low_color:"green",f=this.meta[a].visualize_high_color?this.meta[a].visualize_high_color:"red";this.meta[a].scale=d3.scale.linear().range([e,f]).domain(d).interpolate(d3.interpolateHsl),this.meta[a].html_format=function(a){return"<div>"+a+"</div>"},this.meta[a].td_style=function(a,b){return"background-color:"+a.scale(b)+";"}}},a.DatasetManager.prototype.filter_dataset=function(){var a,b,c,d=[];for(a=0;a<this.meta.length;a++)void 0!==this.meta[a].filter_value&&(c=this.meta[a],"text"!=c.filter_type&&"number"!=c.filter_type||void 0===c.filter_value?"select"==c.filter_type&&void 0!==c.filter_value&&d.push(function(a){var b=a[this.name];return"object"==typeof b&&b.__search_value&&(b=b.__search_value),""+b==""+this.filter_value}.bind(c)):d.push(function(a){var b=this.filter_value.split(" "),d=a[this.name];"object"==typeof d&&d.__search_value&&(d=d.__search_value);for(var e=0;e<b.length;e++)if(0===b[e].indexOf("<=")||0===b[e].indexOf("=<")){if(1*d>1*b[e].replace("<","").replace("=",""))return!1}else if(0===b[e].indexOf(">=")||0===b[e].indexOf("=>")){if(1*d<1*b[e].replace(">","").replace("=",""))return!1}else if(0===b[e].indexOf("<")){if(1*d>=1*b[e].replace("<",""))return!1}else if(0===b[e].indexOf(">")){if(1*d<=1*b[e].replace(">",""))return!1}else if(0===b[e].indexOf("=")||"number"==c.filter_type){if(""+d!==b[e].replace("=",""))return!1}else if(-1==(""+d).indexOf(""+b[e]))return!1;return!0}.bind(c)));this.ds_filtered=[];a:for(a=0;a<this.dataset.length;a++){for(b=0;b<d.length;b++)if(!d[b](this.dataset[a]))continue a;this.ds_filtered.push(this.dataset[a])}return this.ds_filtered},a.DatasetManager.prototype.sort_dataset=function(){var a,b=[];for(this.ds_sorted=[],a=0;a<this.ds_filtered.length;a++)this.ds_sorted.push(this.ds_filtered[a]);for(a=0;a<this.meta.length;a++)"asc"==this.meta[a].sort?b.push(function(a,b){var c=a[this.name],d=b[this.name];return c>d?1:d>c?-1:0}.bind(this.meta[a])):"desc"==this.meta[a].sort&&b.push(function(a,b){var c=a[this.name],d=b[this.name];return c>d?-1:d>c?1:0}.bind(this.meta[a]));for(a=0;a<b.length;a++)this.ds_sorted.sort(b[a]);return this.ds_sorted},a.DatasetManager.prototype.reset_view=function(){var a,b=this.table;for(this.ds_view=[],a=0;a<b.table_row_size&&a+b.row_cursor<this.ds_sorted.length;a++)this.ds_view.push(this.ds_sorted[a+b.row_cursor]);for(this.refresh_ds_view_pos(),this.meta_view=[],a=0;a<b.table_fix_col_size;a++)this.meta_view.push(this.meta[a]);for(a=0;a<b.table_col_size-b.table_fix_col_size;a++)a+this.table.col_cursor<this.meta.length&&this.meta_view.push(this.meta[a+this.table.col_cursor]);this.refresh_meta_view_pos()},a.DatasetManager.prototype.can_scroll_up=function(a){return void 0===a?this.table.row_cursor>0?!0:!1:Math.min(this.table.row_cursor,a)},a.DatasetManager.prototype.can_scroll_down=function(a){return void 0===a?this.table.row_cursor+this.ds_view.length<this.ds_sorted.length?!0:!1:Math.min(this.ds_sorted.length-this.ds_view.length-this.table.row_cursor,a)},a.DatasetManager.prototype.can_scroll_left=function(a){return void 0===a?this.table.col_cursor-this.table.table_fix_col_size>0?!0:!1:Math.min(this.table.col_cursor-this.table.table_fix_col_size,a)},a.DatasetManager.prototype.can_scroll_right=function(a){return void 0===a?this.table.col_cursor+(this.table.table_col_size-this.table.table_fix_col_size)<this.meta.length?!0:!1:Math.min(this.meta.length-this.table.col_cursor-(this.table.table_col_size-this.table.table_fix_col_size),a)},a.DatasetManager.prototype.refresh_ds_view_pos=function(){for(var a=0,b=this.ds_view.length;b>a;a++)this.ds_view[a].__pos=a},a.DatasetManager.prototype.refresh_meta_view_pos=function(){for(var a=0,b=this.meta_view.length;b>a;a++)this.meta_view[a].__pos=a},a.DatasetManager.prototype.select=function(a,b){for(var c=this.dataset,d=[],e=0;e<c.length;e++)a(c[e])&&d.push(void 0===b?c[e]:b(c[e]));return d},a.DatasetLoader=function(a){this.table=a,this.base_url=void 0,this.url_params={},this.onload_options=void 0,this.onload_meta=void 0,this.dataset_filter=void 0,this.after_load_callback=void 0},a.DatasetLoader.prototype.xhr_load=function(b){this.table.overlay_loading instanceof a.Parts.OverlayLoading||(this.table.overlay_loading=new a.Parts.OverlayLoading(this.table,{})),this.table.overlay_loading.render(!0);var c=this.setup_url(b,this.base_url);d3.json(c,function(a){this.dataset_filter&&(a=this.dataset_filter.apply(this,[a])),this.table.initialized?this.table.dataset=this.table.dataset_manager.setup_dataset(a):(this.table.init_dataset(a),this.onload_meta&&this.table.setup_meta(this.onload_meta),this.onload_options&&this.table.setup_options(this.onload_options)),this.table.row_cursor=0,this.table.render(),this.table.overlay_loading.render(!1),void 0!==this.after_load_callback&&this.after_load_callback(this.table)}.bind(this))},a.DatasetLoader.prototype.setup_url=function(b,c){c||(c=this.base_url),b=a.Util.merge(this.url_params,b);var d,e,f="",g=c.split("?"),h={};if(g[1]){d=g[1].split("&");for(var i=0;i<d.length;i++)e=d[i].split("="),h[e[0]]=e[1]}a.Util.merge(h,b);for(var j in h)h.hasOwnProperty(j)&&null!==h[j]&&(""!==f&&(f+="&"),f+=j+"="+h[j]);return g[0]+"?"+f},a.Util={},a.Util.merge=function(b,c){for(var d in c)c.hasOwnProperty(d)&&(b[d]=d in b&&"object"==typeof b[d]&&"object"==typeof c[d]?a.Util.merge(b[d],c[d]):c[d]);return b},a.Util.copy=function(b){if(null===b||void 0===b||"object"!=typeof b)return b;var c;if(b instanceof Date)return c=new Date,c.setTime(b.getTime()),c;if(b instanceof Array){c=[];for(var d=0,e=b.length;e>d;d++)c[d]=a.Util.copy(b[d]);return c}if(b instanceof Object){c={};for(var f in b)b.hasOwnProperty(f)&&(c[f]=a.Util.copy(b[f]));return c}throw new Error("Unable to copy obj! Its type isn't supported.")},a}();